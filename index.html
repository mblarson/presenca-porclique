<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Presen√ßa - Culto</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background-color: #041a2a;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #fff;
        }
        
        .container {
            background-color: #062C3F;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 
                        0 0 100px rgba(255, 126, 0, 0.1);
            width: 100%;
            max-width: 900px;
            padding: 30px 50px 50px;
            text-align: center;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 8px;
            background: linear-gradient(90deg, #1a2a6c, #FF7E00, #b21f1f);
            border-radius: 20px 20px 0 0;
        }
        
        .logo-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .logo {
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo img {
            height: 100%;
            max-width: 250px;
            object-fit: contain;
        }
        
        h1 {
            color: #ffffff;
            margin-bottom: 25px;
            font-size: 2rem;
            font-weight: 700;
            position: relative;
            display: inline-block;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        h1::after {
            content: "";
            position: absolute;
            bottom: -10px;
            left: 25%;
            width: 50%;
            height: 4px;
            background: linear-gradient(90deg, #1a2a6c, #FF7E00);
            border-radius: 2px;
        }
        
        h2 {
            color: #ffffff;
            margin-bottom: 20px;
            font-size: 1.6rem;
            font-weight: 600;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .subtitle {
            color: #e0e0e0;
            margin-bottom: 30px;
            font-size: 1.1rem;
            font-weight: 400;
        }
        
        .btn {
            background: linear-gradient(135deg, #FF7E00, #FF9E40);
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 50px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 8px;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(255, 126, 0, 0.4);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 180px;
        }
        
        .btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(255, 126, 0, 0.6);
        }
        
        .btn:active {
            transform: translateY(-2px);
        }
        
        .btn i {
            margin-right: 8px;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #b21f1f, #e53935);
            box-shadow: 0 5px 15px rgba(178, 31, 31, 0.4);
        }
        
        .btn-danger:hover {
            box-shadow: 0 10px 25px rgba(178, 31, 31, 0.6);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745, #4caf50);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }
        
        .btn-success:hover {
            box-shadow: 0 10px 25px rgba(40, 167, 69, 0.6);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #20c997);
            box-shadow: 0 5px 15px rgba(23, 162, 184, 0.4);
        }
        
        .btn-info:hover {
            box-shadow: 0 10px 25px rgba(23, 162, 184, 0.6);
        }
        
        .btn:disabled {
            background: linear-gradient(135deg, #666, #888);
            cursor: not-allowed;
            box-shadow: none;
            opacity: 0.7;
        }
        
        .btn:disabled:hover {
            transform: none;
        }
        
        .input-group {
            margin: 30px 0;
        }
        
        .input-group input {
            width: 100%;
            max-width: 400px;
            padding: 14px 20px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50px;
            font-size: 1rem;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .input-group input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #FF7E00;
            box-shadow: 0 5px 15px rgba(255, 126, 0, 0.3);
            background-color: rgba(255, 255, 255, 0.15);
        }
        
        .setores-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .setor-item {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .setor-item.visitante {
            grid-column: span 2;
        }
        
        .setor-item::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #1a2a6c, #FF7E00);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }
        
        .setor-item:hover::before {
            transform: scaleX(1);
        }
        
        .setor-item:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
            background-color: rgba(255, 255, 255, 0.15);
        }
        
        .setor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .setor-name {
            font-weight: 700;
            font-size: 1.2rem;
            color: #ffffff;
        }
        
        .setor-counter {
            background: linear-gradient(135deg, #1a2a6c, #3f51b5);
            color: white;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1rem;
            box-shadow: 0 4px 10px rgba(26, 42, 108, 0.5);
        }
        
        .setor-controls {
            display: flex;
            justify-content: space-between;
        }
        
        .control-btn {
            background-color: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .control-btn:hover {
            transform: scale(1.1);
            background-color: rgba(255, 255, 255, 0.25);
        }
        
        .control-btn.minus {
            color: #ff6b6b;
        }
        
        .control-btn.minus:hover {
            border-color: #ff6b6b;
            background-color: rgba(255, 107, 107, 0.2);
        }
        
        .control-btn.plus {
            color: #51cf66;
        }
        
        .control-btn.plus:hover {
            border-color: #51cf66;
            background-color: rgba(81, 207, 102, 0.2);
        }
        
        .resumo-container {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 25px;
            margin: 30px 0;
            text-align: left;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .resumo-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 1rem;
            color: #e0e0e0;
        }
        
        .resumo-item:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 1.2rem;
            margin-top: 12px;
            padding-top: 16px;
            color: #ffffff;
        }
        
        .hidden {
            display: none;
        }
        
        .password-container {
            margin: 30px 0;
        }
        
        .password-container input {
            width: 100%;
            max-width: 320px;
            padding: 14px 20px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50px;
            margin: 0 10px;
            text-align: center;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .password-container input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .password-container input:focus {
            outline: none;
            border-color: #1a2a6c;
            box-shadow: 0 5px 15px rgba(26, 42, 108, 0.4);
            background-color: rgba(255, 255, 255, 0.15);
        }
        
        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            background: linear-gradient(135deg, #28a745, #4caf50);
            color: white;
            padding: 14px 25px;
            border-radius: 50px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transform: translateX(150%);
            transition: transform 0.5s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            font-size: 0.95rem;
        }
        
        .notification i {
            margin-right: 10px;
            font-size: 1.2rem;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #b21f1f, #e53935);
        }
        
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            margin-top: 25px;
        }
        
        .sistema-title {
            margin-bottom: 25px;
        }
        
        .sistema-title h1 {
            font-size: 1.8rem;
            background: linear-gradient(135deg, #ffffff, #FF7E00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
            text-shadow: none;
        }
        
        .sistema-title p {
            color: #e0e0e0;
            font-size: 1rem;
        }
        
        .culto-ativo-container {
            background-color: rgba(255, 126, 0, 0.15);
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0 25px;
            border: 1px solid rgba(255, 126, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .culto-ativo-label {
            font-size: 1rem;
            color: #e0e0e0;
            margin-right: 12px;
        }
        
        .culto-ativo-nome {
            font-size: 1.2rem;
            font-weight: 600;
            color: #FF7E00;
            padding: 6px 16px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            border: 1px solid rgba(255, 126, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .culto-ativo-nome.no-culto {
            color: #888;
            border-color: rgba(136, 136, 136, 0.3);
        }
        
        .footer-controle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            padding: 16px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .total-pessoas {
            display: flex;
            align-items: center;
            font-size: 1.2rem;
            font-weight: 600;
            color: #ffffff;
        }
        
        .total-pessoas i {
            margin-right: 8px;
            color: #FF7E00;
        }
        
        .upload-container {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 30px;
            margin: 30px 0;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        .upload-container:hover {
            border-color: rgba(255, 126, 0, 0.5);
            background-color: rgba(255, 255, 255, 0.15);
        }
        
        .upload-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            min-height: 200px;
        }
        
        .upload-icon {
            font-size: 3rem;
            color: #FF7E00;
            margin-bottom: 15px;
        }
        
        .upload-text {
            font-size: 1.1rem;
            color: #e0e0e0;
            margin-bottom: 15px;
        }
        
        .file-input {
            display: none;
        }
        
        .file-list {
            margin-top: 20px;
            width: 100%;
            text-align: left;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .file-name {
            font-size: 0.95rem;
            color: #e0e0e0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 70%;
        }
        
        .file-remove {
            color: #ff6b6b;
            cursor: pointer;
            font-size: 1.1rem;
        }
        
        .chart-container {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 25px;
            margin: 30px 0;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .chart-wrapper {
            position: relative;
            height: 300px;
            margin: 0 auto;
            max-width: 500px;
        }
        
        .resultados-container {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 25px;
            margin: 30px 0;
            text-align: left;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .resultado-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 1rem;
            color: #e0e0e0;
        }
        
        .resultado-item:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 1.2rem;
            margin-top: 12px;
            padding-top: 16px;
            color: #ffffff;
        }
        
        .resultado-total {
            font-size: 1.5rem;
            font-weight: 700;
            color: #FF7E00;
            margin-bottom: 20px;
            text-align: center;
        }
        
        /* Media queries para dispositivos m√≥veis em modo paisagem */
        @media (max-width: 768px) and (orientation: landscape) {
            .setores-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }
            
            .setor-item.visitante {
                grid-column: span 3;
            }
            
            .setor-name {
                font-size: 1.1rem;
            }
            
            .setor-counter {
                width: 32px;
                height: 32px;
                font-size: 0.9rem;
            }
            
            .control-btn {
                width: 32px;
                height: 32px;
                font-size: 1.1rem;
            }
            
            .setor-item {
                padding: 14px;
            }
        }
        
        /* Media queries para dispositivos m√≥veis em modo retrato */
        @media (max-width: 768px) and (orientation: portrait) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            h2 {
                font-size: 1.4rem;
            }
            
            .setores-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 12px;
            }
            
            .setor-item.visitante {
                grid-column: span 1;
            }
            
            .btn {
                padding: 12px 25px;
                min-width: 160px;
                font-size: 0.9rem;
            }
            
            .logo {
                height: 60px;
            }
            
            .culto-ativo-container {
                flex-direction: column;
                gap: 8px;
            }
            
            .culto-ativo-label {
                margin-right: 0;
            }
            
            .footer-controle {
                flex-direction: column;
                gap: 16px;
            }
            
            .chart-wrapper {
                height: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Logo em todas as telas -->
        <div class="logo-container">
            <div class="logo">
                <img src="https://raw.githubusercontent.com/mblarson/presenca-porclique/main/Untitled%20design.png" alt="Logo UMADE MATS">
            </div>
        </div>
        
        <!-- Tela Inicial -->
        <div id="tela-inicial" class="tela">
            <div class="sistema-title">
                <h1>UMADE MATS</h1>
                <p>Sistema de Controle de Presen√ßa</p>
            </div>
            
            <!-- Container para mostrar o culto ativo -->
            <div id="culto-ativo-container" class="culto-ativo-container">
                <div class="culto-ativo-label">Culto em andamento:</div>
                <div id="culto-ativo-nome" class="culto-ativo-nome"></div>
            </div>
            
            <div class="btn-group">
                <button id="btn-iniciar" class="btn">
                    <i class="fas fa-play"></i> Iniciar Culto
                </button>
                <button id="btn-continuar" class="btn hidden">
                    <i class="fas fa-redo"></i> Continuar Culto
                </button>
                <button id="btn-gerar-resultados" class="btn btn-info">
                    <i class="fas fa-chart-pie"></i> Gerar Resultados
                </button>
            </div>
        </div>
        
        <!-- Tela de Nome do Culto -->
        <div id="tela-nome" class="tela hidden">
            <h1>Informar Nome do Culto</h1>
            <div class="input-group">
                <input type="text" id="input-nome-culto" placeholder="Digite o nome do culto">
            </div>
            <div class="btn-group">
                <button id="btn-salvar-nome" class="btn">
                    <i class="fas fa-save"></i> Salvar Nome
                </button>
                <button id="btn-voltar-inicio" class="btn btn-danger">
                    <i class="fas fa-arrow-left"></i> Voltar
                </button>
            </div>
        </div>
        
        <!-- Tela de Controle de Presen√ßa -->
        <div id="tela-controle" class="tela hidden">
            <h1>CONTROLE DE PRESEN√áA</h1>
            <h2 id="nome-culto-exibicao"></h2>
            <p class="subtitle">Informe seu Setor</p>
            
            <div class="setores-grid" id="setores-grid">
                <!-- Setores ser√£o inseridos dinamicamente -->
            </div>
            
            <!-- Footer com total de pessoas e bot√£o encerrar -->
            <div class="footer-controle">
                <div class="total-pessoas">
                    <i class="fas fa-users"></i>
                    <span>Total: <span id="total-geral-value">0</span> pessoas</span>
                </div>
                <button id="btn-encerrar" class="btn btn-danger">
                    <i class="fas fa-stop"></i> ENCERRAR CULTO
                </button>
            </div>
        </div>
        
        <!-- Tela de Senha -->
        <div id="tela-senha" class="tela hidden">
            <h1>Encerrar Culto</h1>
            <p class="subtitle">Digite a senha para encerrar o culto</p>
            
            <div class="password-container">
                <input type="password" id="input-senha" placeholder="Senha">
            </div>
            
            <div class="btn-group">
                <button id="btn-confirmar-senha" class="btn">
                    <i class="fas fa-check"></i> Confirmar
                </button>
                <button id="btn-cancelar-senha" class="btn btn-danger">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </div>
        
        <!-- Tela de Resumo -->
        <div id="tela-resumo" class="tela hidden">
            <h1>Resumo do Culto</h1>
            <h2 id="nome-culto-resumo"></h2>
            
            <div class="resumo-container" id="resumo-container">
                <!-- Resumo ser√° inserido dinamicamente -->
            </div>
            
            <div class="btn-group">
                <button id="btn-gerar-json" class="btn btn-success">
                    <i class="fas fa-file-download"></i> Gerar JSON
                </button>
                <button id="btn-download-imagem" class="btn btn-info">
                    <i class="fas fa-image"></i> Download Imagem
                </button>
                <button id="btn-novo-culto" class="btn">
                    <i class="fas fa-plus"></i> Iniciar Novo Culto
                </button>
            </div>
        </div>
        
        <!-- Tela de Upload JSON -->
        <div id="tela-upload" class="tela hidden">
            <h1>Gerar Resultados</h1>
            <p class="subtitle">Selecione os arquivos JSON para an√°lise</p>
            
            <div class="upload-container">
                <div class="upload-area" id="upload-area">
                    <i class="fas fa-cloud-upload-alt upload-icon"></i>
                    <p class="upload-text">Arraste e solte os arquivos JSON aqui ou clique para selecionar</p>
                    <button class="btn" id="btn-selecionar-arquivos">
                        <i class="fas fa-folder-open"></i> Selecionar Arquivos
                    </button>
                    <input type="file" id="file-input" class="file-input" multiple accept=".json">
                </div>
                
                <div class="file-list" id="file-list">
                    <!-- Lista de arquivos ser√° inserida dinamicamente -->
                </div>
            </div>
            
            <div class="btn-group">
                <button id="btn-gerar-resultados-json" class="btn btn-success" disabled>
                    <i class="fas fa-chart-bar"></i> Gerar Resultado
                </button>
                <button id="btn-voltar-inicio-upload" class="btn btn-danger">
                    <i class="fas fa-arrow-left"></i> Voltar
                </button>
            </div>
        </div>
        
        <!-- Tela de Resultados -->
        <div id="tela-resultados" class="tela hidden">
            <h1>Resultados de Presen√ßa</h1>
            
            <div class="resultado-total" id="resultado-total">
                Total de Pessoas: 0
            </div>
            
            <div class="chart-container">
                <div class="chart-wrapper">
                    <canvas id="presenca-chart"></canvas>
                </div>
            </div>
            
            <div class="resultados-container" id="resultados-container">
                <!-- Resultados ser√£o inseridos dinamicamente -->
            </div>
            
            <div class="btn-group">
                <button id="btn-download-imagem-resultados" class="btn btn-info">
                    <i class="fas fa-image"></i> Download Imagem
                </button>
                <button id="btn-voltar-inicio-resultados" class="btn">
                    <i class="fas fa-arrow-left"></i> Voltar ao In√≠cio
                </button>
            </div>
        </div>
    </div>
    
    <div id="notification" class="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notification-text"></span>
    </div>
    
    <script>
        // Elementos do DOM
        const telas = {
            inicial: document.getElementById('tela-inicial'),
            nome: document.getElementById('tela-nome'),
            controle: document.getElementById('tela-controle'),
            senha: document.getElementById('tela-senha'),
            resumo: document.getElementById('tela-resumo'),
            upload: document.getElementById('tela-upload'),
            resultados: document.getElementById('tela-resultados')
        };
        
        const botoes = {
            iniciar: document.getElementById('btn-iniciar'),
            continuar: document.getElementById('btn-continuar'),
            salvarNome: document.getElementById('btn-salvar-nome'),
            voltarInicio: document.getElementById('btn-voltar-inicio'),
            encerrar: document.getElementById('btn-encerrar'),
            confirmarSenha: document.getElementById('btn-confirmar-senha'),
            cancelarSenha: document.getElementById('btn-cancelar-senha'),
            gerarJson: document.getElementById('btn-gerar-json'),
            novoCulto: document.getElementById('btn-novo-culto'),
            gerarResultados: document.getElementById('btn-gerar-resultados'),
            selecionarArquivos: document.getElementById('btn-selecionar-arquivos'),
            gerarResultadosJson: document.getElementById('btn-gerar-resultados-json'),
            voltarInicioUpload: document.getElementById('btn-voltar-inicio-upload'),
            downloadImagem: document.getElementById('btn-download-imagem'),
            downloadImagemResultados: document.getElementById('btn-download-imagem-resultados'),
            voltarInicioResultados: document.getElementById('btn-voltar-inicio-resultados')
        };
        
        const inputs = {
            nomeCulto: document.getElementById('input-nome-culto'),
            senha: document.getElementById('input-senha'),
            fileInput: document.getElementById('file-input')
        };
        
        const exibicoes = {
            nomeCulto: document.getElementById('nome-culto-exibicao'),
            nomeCultoResumo: document.getElementById('nome-culto-resumo'),
            resumoContainer: document.getElementById('resumo-container'),
            setoresGrid: document.getElementById('setores-grid'),
            cultoAtivoContainer: document.getElementById('culto-ativo-container'),
            cultoAtivoNome: document.getElementById('culto-ativo-nome'),
            totalGeralValue: document.getElementById('total-geral-value'),
            fileList: document.getElementById('file-list'),
            resultadoTotal: document.getElementById('resultado-total'),
            resultadosContainer: document.getElementById('resultados-container'),
            uploadArea: document.getElementById('upload-area')
        };
        
        const notificationText = document.getElementById('notification-text');
        
        // Constantes
        const SENHA_PADRAO = 'secretaria';
        const SETORES = ['A', 'B', 'C1', 'C2', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'M', 'N', 'VISITANTE'];
        
        // Estado do aplicativo
        let estado = {
            cultoAtivo: false,
            nomeCulto: '',
            setores: {},
            totalGeral: 0,
            arquivosJSON: [],
            dadosResultados: {}
        };
        
        // Gr√°fico
        let presencaChart = null;
        
        // Inicializar setores
        function inicializarSetores() {
            SETORES.forEach(setor => {
                estado.setores[setor] = 0;
            });
            estado.totalGeral = 0;
        }
        
        // Salvar estado no localStorage
        function salvarEstado() {
            localStorage.setItem('estadoCulto', JSON.stringify(estado));
        }
        
        // Carregar estado do localStorage
        function carregarEstado() {
            const estadoSalvo = localStorage.getItem('estadoCulto');
            if (estadoSalvo) {
                estado = JSON.parse(estadoSalvo);
            } else {
                inicializarSetores();
            }
        }
        
        // Atualizar a tela inicial com base no estado do culto
        function atualizarTelaInicial() {
            // Sempre mostrar o container
            exibicoes.cultoAtivoContainer.classList.remove('hidden');
            
            // Verificar se h√° um culto ativo
            if (estado.cultoAtivo && estado.nomeCulto && estado.nomeCulto.trim() !== '') {
                botoes.continuar.classList.remove('hidden');
                botoes.iniciar.disabled = true;
                exibicoes.cultoAtivoNome.textContent = estado.nomeCulto;
                exibicoes.cultoAtivoNome.classList.remove('no-culto');
            } else {
                botoes.continuar.classList.add('hidden');
                botoes.iniciar.disabled = false;
                exibicoes.cultoAtivoNome.textContent = 'Nenhum culto';
                exibicoes.cultoAtivoNome.classList.add('no-culto');
            }
        }
        
        // Mostrar notifica√ß√£o
        function mostrarNotificacao(mensagem, tipo = 'success') {
            const notification = document.getElementById('notification');
            notificationText.textContent = mensagem;
            
            if (tipo === 'error') {
                notification.classList.add('error');
                notification.innerHTML = `<i class="fas fa-exclamation-circle"></i><span id="notification-text">${mensagem}</span>`;
            } else {
                notification.classList.remove('error');
                notification.innerHTML = `<i class="fas fa-check-circle"></i><span id="notification-text">${mensagem}</span>`;
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Navegar entre telas
        function mostrarTela(nomeTela) {
            Object.values(telas).forEach(tela => {
                tela.classList.add('hidden');
            });
            
            telas[nomeTela].classList.remove('hidden');
            
            // Se estiver voltando para a tela inicial, atualize o estado
            if (nomeTela === 'inicial') {
                atualizarTelaInicial();
            }
        }
        
        // Atualizar totalizador geral
        function atualizarTotalGeral() {
            estado.totalGeral = Object.values(estado.setores).reduce((sum, count) => sum + count, 0);
            exibicoes.totalGeralValue.textContent = estado.totalGeral;
            salvarEstado();
        }
        
        // Renderizar setores na tela de controle
        function renderizarSetores() {
            exibicoes.setoresGrid.innerHTML = '';
            
            SETORES.forEach(setor => {
                const setorDiv = document.createElement('div');
                setorDiv.className = 'setor-item';
                
                // Adicionar classe especial para o setor VISITANTE
                if (setor === 'VISITANTE') {
                    setorDiv.classList.add('visitante');
                }
                
                setorDiv.innerHTML = `
                    <div class="setor-header">
                        <div class="setor-name">${setor}</div>
                        <div class="setor-counter" id="contador-${setor}">${estado.setores[setor]}</div>
                    </div>
                    <div class="setor-controls">
                        <button class="control-btn minus" data-setor="${setor}">-</button>
                        <button class="control-btn plus" data-setor="${setor}">+</button>
                    </div>
                `;
                
                // Adicionar evento de clique no setor inteiro
                setorDiv.addEventListener('click', (e) => {
                    // Se o clique foi nos bot√µes de controle, n√£o incrementa
                    if (e.target.classList.contains('control-btn')) return;
                    
                    incrementarSetor(setor);
                });
                
                exibicoes.setoresGrid.appendChild(setorDiv);
            });
            
            // Adicionar eventos aos bot√µes de controle
            document.querySelectorAll('.control-btn.minus').forEach(btn => {
                btn.addEventListener('click', () => {
                    const setor = btn.getAttribute('data-setor');
                    decrementarSetor(setor);
                });
            });
            
            document.querySelectorAll('.control-btn.plus').forEach(btn => {
                btn.addEventListener('click', () => {
                    const setor = btn.getAttribute('data-setor');
                    incrementarSetor(setor);
                });
            });
            
            // Atualizar o totalizador geral
            atualizarTotalGeral();
        }
        
        // Incrementar contador de um setor
        function incrementarSetor(setor) {
            estado.setores[setor]++;
            document.getElementById(`contador-${setor}`).textContent = estado.setores[setor];
            atualizarTotalGeral();
        }
        
        // Decrementar contador de um setor
        function decrementarSetor(setor) {
            if (estado.setores[setor] > 0) {
                estado.setores[setor]--;
                document.getElementById(`contador-${setor}`).textContent = estado.setores[setor];
                atualizarTotalGeral();
            }
        }
        
        // Renderizar resumo
        function renderizarResumo() {
            exibicoes.nomeCultoResumo.textContent = estado.nomeCulto;
            exibicoes.resumoContainer.innerHTML = '';
            
            let total = 0;
            
            SETORES.forEach(setor => {
                const count = estado.setores[setor];
                total += count;
                
                const resumoItem = document.createElement('div');
                resumoItem.className = 'resumo-item';
                resumoItem.innerHTML = `
                    <span>Setor ${setor}:</span>
                    <span>${count} pessoas</span>
                `;
                
                exibicoes.resumoContainer.appendChild(resumoItem);
            });
            
            const totalItem = document.createElement('div');
            totalItem.className = 'resumo-item';
            totalItem.innerHTML = `
                <span>TOTAL GERAL:</span>
                <span>${total} pessoas</span>
            `;
            
            exibicoes.resumoContainer.appendChild(totalItem);
        }
        
        // Gerar JSON
        function gerarJSON() {
            const dados = {
                nomeCulto: estado.nomeCulto,
                data: new Date().toISOString(),
                setores: estado.setores,
                total: estado.totalGeral
            };
            
            const jsonStr = JSON.stringify(dados, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `presenca-${estado.nomeCulto.replace(/\s+/g, '-').toLowerCase()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            mostrarNotificacao('JSON gerado com sucesso!');
        }
        
        // Download de imagem
        function downloadImagem(elemento, nomeArquivo) {
            // Configura√ß√µes para o html2canvas
            const config = {
                backgroundColor: null,
                scale: 2, // Aumenta a qualidade da imagem
                logging: false,
                useCORS: true,
                allowTaint: true
            };
            
            html2canvas(elemento, config).then(canvas => {
                // Criar um link para download
                const link = document.createElement('a');
                link.download = nomeArquivo;
                link.href = canvas.toDataURL('image/png');
                link.click();
                mostrarNotificacao('Imagem baixada com sucesso!');
            }).catch(err => {
                console.error('Erro ao gerar imagem:', err);
                mostrarNotificacao('Erro ao gerar imagem', 'error');
            });
        }
        
        // Processar arquivos JSON
        function processarArquivosJSON() {
            if (estado.arquivosJSON.length === 0) {
                mostrarNotificacao('Selecione pelo menos um arquivo JSON', 'error');
                return;
            }
            
            // Inicializar dados de resultados
            estado.dadosResultados = {};
            SETORES.forEach(setor => {
                estado.dadosResultados[setor] = 0;
            });
            
            // Processar cada arquivo
            estado.arquivosJSON.forEach(arquivo => {
                try {
                    const dados = JSON.parse(arquivo.conteudo);
                    
                    // Somar os valores de cada setor
                    SETORES.forEach(setor => {
                        if (dados.setores && dados.setores[setor]) {
                            estado.dadosResultados[setor] += dados.setores[setor];
                        }
                    });
                } catch (e) {
                    console.error('Erro ao processar arquivo:', arquivo.nome, e);
                }
            });
            
            // Calcular total geral
            const totalGeral = Object.values(estado.dadosResultados).reduce((sum, count) => sum + count, 0);
            
            // Exibir resultados
            exibirResultados(totalGeral);
            
            // Navegar para a tela de resultados
            mostrarTela('resultados');
        }
        
        // Exibir resultados
        function exibirResultados(totalGeral) {
            // Atualizar total geral
            exibicoes.resultadoTotal.textContent = `Total de Pessoas: ${totalGeral}`;
            
            // Limpar container de resultados
            exibicoes.resultadosContainer.innerHTML = '';
            
            // Adicionar itens de resultado
            SETORES.forEach(setor => {
                const count = estado.dadosResultados[setor];
                const percentual = totalGeral > 0 ? ((count / totalGeral) * 100).toFixed(1) : 0;
                
                const resultadoItem = document.createElement('div');
                resultadoItem.className = 'resultado-item';
                resultadoItem.innerHTML = `
                    <span>Setor ${setor}:</span>
                    <span>${count} pessoas (${percentual}%)</span>
                `;
                
                exibicoes.resultadosContainer.appendChild(resultadoItem);
            });
            
            // Adicionar item total
            const totalItem = document.createElement('div');
            totalItem.className = 'resultado-item';
            totalItem.innerHTML = `
                <span>TOTAL GERAL:</span>
                <span>${totalGeral} pessoas</span>
            `;
            
            exibicoes.resultadosContainer.appendChild(totalItem);
            
            // Gerar gr√°fico
            gerarGraficoPizza(estado.dadosResultados, totalGeral);
        }
        
        // Gerar gr√°fico de pizza
        function gerarGraficoPizza(dados, total) {
            const ctx = document.getElementById('presenca-chart').getContext('2d');
            
            // Destruir gr√°fico anterior se existir
            if (presencaChart) {
                presencaChart.destroy();
            }
            
            // Preparar dados para o gr√°fico
            const labels = [];
            const data = [];
            const backgroundColors = [];
            
            // Cores para cada setor
            const colors = [
                '#FF7E00', '#1a2a6c', '#b21f1f', '#28a745', '#17a2b8',
                '#6f42c1', '#fd7e14', '#20c997', '#e83e8c', '#6610f2',
                '#f8f9fa', '#343a40', '#ffc107', '#6c757d'
            ];
            
            SETORES.forEach((setor, index) => {
                if (dados[setor] > 0) {
                    labels.push(`Setor ${setor}`);
                    data.push(dados[setor]);
                    backgroundColors.push(colors[index]);
                }
            });
            
            // Criar gr√°fico
            presencaChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: '#062C3F',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#e0e0e0',
                                font: {
                                    size: 12,
                                    family: "'Poppins', sans-serif"
                                },
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const percentual = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value} pessoas (${percentual}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Event Listeners
        botoes.iniciar.addEventListener('click', () => {
            // Verificar se j√° existe um culto ativo
            if (estado.cultoAtivo) {
                mostrarNotificacao('J√° existe um culto em andamento. Encerre-o antes de iniciar um novo.', 'error');
                return;
            }
            
            mostrarTela('nome');
        });
        
        botoes.continuar.addEventListener('click', () => {
            exibicoes.nomeCulto.textContent = estado.nomeCulto;
            renderizarSetores();
            mostrarTela('controle');
        });
        
        botoes.salvarNome.addEventListener('click', () => {
            const nome = inputs.nomeCulto.value.trim();
            
            if (nome === '') {
                mostrarNotificacao('Por favor, digite o nome do culto', 'error');
                return;
            }
            
            estado.nomeCulto = nome;
            estado.cultoAtivo = true;
            salvarEstado();
            
            exibicoes.nomeCulto.textContent = nome;
            renderizarSetores();
            mostrarTela('controle');
            mostrarNotificacao('Culto iniciado com sucesso!');
        });
        
        botoes.voltarInicio.addEventListener('click', () => {
            mostrarTela('inicial');
        });
        
        botoes.encerrar.addEventListener('click', () => {
            mostrarTela('senha');
        });
        
        botoes.confirmarSenha.addEventListener('click', () => {
            const senha = inputs.senha.value;
            
            if (senha !== SENHA_PADRAO) {
                mostrarNotificacao('Senha incorreta!', 'error');
                return;
            }
            
            estado.cultoAtivo = false;
            salvarEstado();
            
            renderizarResumo();
            mostrarTela('resumo');
            mostrarNotificacao('Culto encerrado com sucesso!');
        });
        
        botoes.cancelarSenha.addEventListener('click', () => {
            inputs.senha.value = '';
            mostrarTela('controle');
        });
        
        botoes.gerarJson.addEventListener('click', gerarJSON);
        
        botoes.downloadImagem.addEventListener('click', () => {
            downloadImagem(telas.resumo, `resumo-${estado.nomeCulto.replace(/\s+/g, '-').toLowerCase()}.png`);
        });
        
        botoes.novoCulto.addEventListener('click', () => {
            inicializarSetores();
            salvarEstado();
            
            // Atualizar a tela inicial
            atualizarTelaInicial();
            
            mostrarTela('inicial');
            mostrarNotificacao('Pronto para iniciar um novo culto!');
        });
        
        botoes.gerarResultados.addEventListener('click', () => {
            mostrarTela('upload');
        });
        
        botoes.selecionarArquivos.addEventListener('click', () => {
            inputs.fileInput.click();
        });
        
        inputs.fileInput.addEventListener('change', (e) => {
            processarArquivosSelecionados(e.target.files);
        });
        
        // Drag and drop
        exibicoes.uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            exibicoes.uploadArea.style.backgroundColor = 'rgba(255, 126, 0, 0.1)';
        });
        
        exibicoes.uploadArea.addEventListener('dragleave', () => {
            exibicoes.uploadArea.style.backgroundColor = '';
        });
        
        exibicoes.uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            exibicoes.uploadArea.style.backgroundColor = '';
            
            processarArquivosSelecionados(e.dataTransfer.files);
        });
        
        // Processar arquivos selecionados
        function processarArquivosSelecionados(arquivos) {
            // Limpar lista de arquivos atual
            estado.arquivosJSON = [];
            exibicoes.fileList.innerHTML = '';
            
            // Verificar se h√° arquivos
            if (arquivos.length === 0) {
                botoes.gerarResultadosJson.disabled = true;
                return;
            }
            
            // Processar cada arquivo
            Array.from(arquivos).forEach(arquivo => {
                // Verificar se √© um arquivo JSON
                if (arquivo.type === 'application/json' || arquivo.name.endsWith('.json')) {
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        // Adicionar arquivo √† lista
                        estado.arquivosJSON.push({
                            nome: arquivo.name,
                            conteudo: e.target.result
                        });
                        
                        // Adicionar √† interface
                        adicionarArquivoLista(arquivo.name);
                        
                        // Habilitar bot√£o de gerar resultados
                        botoes.gerarResultadosJson.disabled = false;
                    };
                    
                    reader.readAsText(arquivo);
                } else {
                    mostrarNotificacao(`O arquivo ${arquivo.name} n√£o √© um JSON v√°lido`, 'error');
                }
            });
        }
        
        // Adicionar arquivo √† lista
        function adicionarArquivoLista(nomeArquivo) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            
            const fileName = document.createElement('div');
            fileName.className = 'file-name';
            fileName.textContent = nomeArquivo;
            
            const fileRemove = document.createElement('i');
            fileRemove.className = 'fas fa-times-circle file-remove';
            fileRemove.addEventListener('click', () => {
                // Remover arquivo da lista
                estado.arquivosJSON = estado.arquivosJSON.filter(arquivo => arquivo.nome !== nomeArquivo);
                
                // Remover da interface
                fileItem.remove();
                
                // Desabilitar bot√£o se n√£o houver arquivos
                if (estado.arquivosJSON.length === 0) {
                    botoes.gerarResultadosJson.disabled = true;
                }
            });
            
            fileItem.appendChild(fileName);
            fileItem.appendChild(fileRemove);
            exibicoes.fileList.appendChild(fileItem);
        }
        
        botoes.gerarResultadosJson.addEventListener('click', processarArquivosJSON);
        
        botoes.voltarInicioUpload.addEventListener('click', () => {
            // Limpar arquivos
            estado.arquivosJSON = [];
            exibicoes.fileList.innerHTML = '';
            botoes.gerarResultadosJson.disabled = true;
            
            mostrarTela('inicial');
        });
        
        botoes.downloadImagemResultados.addEventListener('click', () => {
            downloadImagem(telas.resultados, 'resultados-presenca.png');
        });
        
        botoes.voltarInicioResultados.addEventListener('click', () => {
            // Limpar dados de resultados
            estado.dadosResultados = {};
            
            // Destruir gr√°fico
            if (presencaChart) {
                presencaChart.destroy();
                presencaChart = null;
            }
            
            mostrarTela('inicial');
        });
        
        // Inicializa√ß√£o
        window.addEventListener('DOMContentLoaded', () => {
            carregarEstado();
            atualizarTelaInicial();
        });
    </script>
</body>
</html>